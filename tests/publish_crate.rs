mod common;

use axum::body::Bytes;
use common::memory_storage::MemoryStorage;
use common::setup::build_repository;
use raktar::api::publish::publish_crate;
use raktar::auth::AuthenticatedUser;
use raktar::repository::DynRepository;
use raktar::storage::DynCrateStorage;
use std::sync::Arc;
use tracing_test::traced_test;

#[tokio::test]
#[traced_test]
async fn test_publishing_new_crate() {
    let storage = Arc::new(MemoryStorage::default()) as DynCrateStorage;
    let repository = Arc::new(build_repository().await) as DynRepository;
    let user = AuthenticatedUser { id: 1 };
    let data = Bytes::from_static(CRATE_BYTES_V1);

    publish_crate(user, storage, repository, data)
        .await
        .expect("publish to succeed");
}

static CRATE_BYTES_V1: &[u8; 6194] = b"\x13\r\0\0{\"name\":\"private3\",\"vers\":\"1.2.3\",\"deps\":[{\"optional\":false,\"default_features\":true,\"name\":\"serde\",\"features\":[\"derive\"],\"version_req\":\"^1.0.150\",\"target\":null,\"kind\":\"normal\",\"registry\":\"https://github.com/rust-lang/crates.io-index\"},{\"optional\":false,\"default_features\":true,\"name\":\"serde_json\",\"features\":[],\"version_req\":\"^1.0.90\",\"target\":null,\"kind\":\"normal\",\"registry\":\"https://github.com/rust-lang/crates.io-index\"}],\"features\":{},\"authors\":[],\"description\":\"A private crate for testing purposes.\",\"documentation\":null,\"homepage\":null,\"readme\":\"# Raktar\\n\\n`raktar` is an alternative registry for Rust leveraging serverless AWS components.\\nIts aim is to offer a solution you can deploy in your AWS environment with a\\nfew simple commands using AWS CDK.\\n\\nIt supports the new [sparse registry](https://blog.rust-lang.org/2022/06/22/sparse-registry-testing.html)\\nprotocol. `git` based registry support is not planned.\\n\\nThere is no plan to support any currently widespread workaround for authentication.\\nThe hope is that by the time development on this project is complete, the\\n[registry-auth](https://doc.rust-lang.org/nightly/cargo/reference/unstable.html#registry-auth)\\nflag will be stabilised.\\n\\n> **Warning**\\n>\\n> This application is work in progress. The key APIs work, allowing you to publish crates, query the index, download crates, yank and unyank versions.\\n> However, the backend is somewhat useless without the frontend application that's in early stages of development and has not been open-sourced yet.\\n\\n# Pre-requisites\\n\\nThe core application is written in pure Rust, however `raktar` uses Python for the infrastructure code (using AWS CDK). Therefore, you will need both to compile and deploy the application.\\n\\n## Application pre-requisites\\nThe following tools are required to compile and run the application:\\n- Rust\\n\\n## Infrastructure pre-requisites\\nThe following tools are required to deploy the service:\\n- Python 3.9+\\n- [poetry 1.4+](https://python-poetry.org/)\\n- an AWS account\\n- an [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html) profile with the appropriate permissions for CDK deployments\\n- [CDK CLI](https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html)\\n- [cargo-lambda](https://www.cargo-lambda.info/) to compile Rust for AWS Lambda\\n\\n# Deployment\\n\\nTo install the Python dependencies, run `poetry install`.\\n\\nTo configure the service, update the `infrastructure/.env` file with your preferred settings. `raktar` requires you to have a public hosted zone for your custom domain where it can create the necessary A record for the service. Set the domain name and the hosted zone ID in the `.env` file.\\n\\nOnce the service is configured, run\\n\\n```shell\\npoetry run cdk deploy --profile <AWS_PROFILE> --all\\n```\\n\\nto deploy the service.\\n\\nTo add the alternate registry, modify the `config.toml` (either in your project, or globally in `~/.cargo/config.toml`):\\n\\n```toml\\n[registries]\\nmy-registry = { index = \\\"sparse+https://{domain}/\\\", token = \\\"does-not-matter-for-now\\\" }\\n```\\n\\n> **Note**\\n>\\n> `raktar` only support sparse indexes, not the original `git` based indexes.\\n\",\"readme_file\":\"README.md\",\"keywords\":[],\"categories\":[],\"license\":null,\"license_file\":null,\"repository\":null,\"badges\":{},\"links\":null,\"rust_version\":null}\x17\x0b\0\0\x1f\x8b\x08\x08\0\0\0\0\x02\xffprivate3-1.2.3.crate\0\xed[mS\xdc8\x12\xe6\xb3\x7f\x85\xcal\xddA2c\xcf+$l`\x8b\x05\xb2\xcb\x1eI(B.\xb5Eq\x8c\xb053Z<\x96#\xc9Lf\xb7r\xbf\xfd\x9e\x96=\xaf\x90\xa2\xee\x8e\x9b\xda\x1c\xe3\x0f\x89\xedQ\xb7\xba[\xddOwK&\xd3\xf2\x96[\xd1\xac\xd6\x83F\xd0\x0c\x83\x88\xeb\x9e\xba\xba\x8d\xcc\x95L\xbb*\xf8\xcd\xa8t\xed\xbf\xbdj\xb8\xb6Z\xad{\xdf\xd3UonM\xee\xf1\x84\xfbz\xa3\xbd\xddZ\xab\xad-\xe1\xca\x8d\xe5\x9a\xb1\xb5'z\xfd\xe11\xe6\xf7\xa4\xf5w\x18\xdd\xe2\xc1\xf4y\x1dO~;\xeen\xd7\xe3\xfa\xcbn\xad\xd5n\xb7[\xd1\xd6\xcbf\xa3\xf1\xe2\xc5v\xb7V\x13\xcdV}\xbb\xd6\x10b{\xbb\xc5}\x90}\xa9\x10\x9b\x8c\xdb>\xdc\x86\xbc\x87\x18\xf8\xde\x97\xb5\xd5\xf5'\xbf\xb2\x85\xf8\x87+\xc8^\xaa\xb4x\xc49\xc6\xf1_\x06\xf8\xe2\xff\xb5Z\xa3\xb5V\xaf\xb5\xb6\xea\xb5F\xad\xd1\xa4\xf7\xf5f\xb3]\xfb\xb6\xe2\x7fQ\xb9o\xe4\n\xa1}OX/< \xe0\x0f\x12\x15\xddx\xab\xa8x\xba\xf1/c\xc1\x1f\x1b\x05\x1e\x8a\xff\xc6Vm1\xfe[\xcdfc\x15\xffK\xb8\xd6\xd9\xa1\xe8\xf2<\xb1\xacX\xf0\x98ue\"\x8c\x17\x9a\xbeH\xba\xa1\x17\x0e\x95\xbe1\x19\x8fD\xf0y\x90x\xeb\xec(\x96V\xe9\xea57\x18\xfb\xf3\xf9\xf9);H\xa4H-\xd3\xe2S.\x8c\x05i\xdf\xda\xec\xac|\nAr\xc8-7*\xd7\x91`\xc0\x17\x9e0\x03\x0e\xbc'\x16\xa7\x8c1\xee\xbd\x1b\x07\xb2\xd9\xa7\xc0\x919\x01V\x11\xbb\x84\xf8\xe7CC\xc6^V\xfeo\xb5\xb6\xee\xe4\xff\xad\xad\xd6*\xfe\x97p\xbd\xfa\x01\x0b\xcdn\x856R\xa5\xbb~=\xa8\xf9L\xa4\x91\x8ae\xda\xdb\xf5?\x9c\xbf\xae\xbe\xf0\x7f\xd8\xf3^eZ\xfd&\";\x1d\xd9\xf2\xf7P\xf3\xbf\x8a\xd4 S)\xc5\x7f\xca\x07b\xd7\xe7Q\xa4\xf2\xd4\xbe\x17\xd6\x82\x83q\x830Le\x16T\x931V\xde\x8a3\xd1\xc3+\x9f\xdd\xf2$\xc7\xcb\xdcT\x057\xb6Z\xf7Yx\x1f\x91\x16\x11fIF\x1f\x80;\x05\xe9\x989F&\xd2\xd8\xf1\xc3\x94\xf0\xab\x9c1$\x9c\x92\xbc\n\x8b\xf1N\x9fp\xa2\x10\x94\x0eK\xad\xf7\x9eX\xfc\x0fT\x9c\x03\x91\x1f\x0b\x03\x1e\x8c\xffz\xe3N\xfeo7\x9b\xab\xf8\xff\x06\xe3\xff\xb4\x18\xf7\xc6y\xd0\x1b\x9e\"\xcd\xeb1\x08\x94n5\x89\xc1\xe2\xd9e\xff\\'\xbb>\xdd\xec\x84\xe1w\xa7g\xef~9:8\xbf:<>\xfb\xae\xf4HrS!l \x07\x89\xef\x08h\xafa\xd7\x7fp\xe8\x18J\xc2\x99\xb9\x9f\\\x8c\xff\xdb\xf1?c\xc2e\xc4\xffV\xbb~7\xfe\x1b\xdb\xab\xf8\xff\x13\xc5\x7f\x19\xabv\x94!\xc8\x0fNO\xaf\xde\xbc;\xfcpr\xe4?\x08\x08o\xc5\xb0\0\x833\xa5\xec\x02 D*\xb54r.\xfa\x0b\xc6.\xa2\xa7\t\xbeh\x1f^\xab$\x16\xfa\xab\xc3C\xa3#\x9fIs\x8e\xc6\xa3\xe8\x1c0\x8c'F\xcc&~\xf19J\xf2\xf8AV\xc5\xb6\xc8\x0c\x80\x94\xb2\x8eK\x13\r\xea\xa3\xd4\xeaQi\x12\x99\xf6\x85\x96V\xc4\xbf\xc473\x15\xcc\xe2\xb0Y=\0dJ\x93\xacf^\xcc\x05|*,\xbf\xb7\xcc\xf8\xbf\x8d\x96Z\xff7Z\xdb\xab\xfa\xff\xff$\xff\xff=2\x87\x12\xb5::\xfc\xd1\x1b\x9ee\xb3M\xc0\xa0xf\xf1x\xc0\xae\x0f\xfc\x88\xe0\xfe?I{\xbf\xf3?\xed\xe4\xbc\xfc\xfc_\xec\x02[\xf5x\xc1\xbf\xf6\xe0\xf9_\xbdYo/\x9e\xff\xd5\xda\xdb\x8d\xd5\xf9\xdfR\xf6\xff\xce\x7f>~\xcf^\x1f\x9f\x1c1\xfc\xbf\xff\xe1\xfc\xdd\x9b\xfd\xf3\xe3\x83\xfd\x93\x93_\xd9OGo\x8f\xce\xf6\xcf\x8f\x0e\xd9\x8f\xbf\xb2\x83\xfd\xb3\x9f\xdey\xeb\xde:\xfb\xd8\x17)\xcb\xb3DqB\t\x16i8\x90aV1\xdb\x17L\xa377\x94\xf0\x9c+\xb1\xa1L\x12\xc6sx\x14\xb72\xe2I2\x02\x03?Uz\xc0\x13\xf9;R\xde\xd4\xe3\x8am@J\x8al\xc0?K\x0c`\x84\x05\xa0\xbb\x96\x89\xb4D8\x94\xb6\xcf\xc0d\x0cC\x86\xa9n9\x11Oc\xfcb\x14\x04\x18R\"f\x1dj\x11:,\x16\x99Hc@\x9a\x14\x06\x1c\xac\x9aJ\xb8!\x82^P)\xe5\x0f\xa4\xda\x9c\x1b\x1c8]\x8f\xbbl\xa4r\xc65iV\xe8k\xfb\xd28Y\xd9\xb5`|H?\xd9>\xb7N{\xa5eO\xa6\x90|\xaa\x96\x13\x1b\"'\xf2F$#\x96(uC\xe2\x8f\0\x83\xdd\xae\xd0\x04\x9d\x1b$\xfc \x8f\xfal\xa0\x8a\x89\x8cJ\xf9u\"6!\x04{/\xc4\x0c\xbb\x80\xa6pF\x9a\x9b\xaf,O \xb5w\x91\xf1\xe8\x06e\xd6\xa5'b\xe96Bv\x99\x8f\xccZ\xf7=\xc2hz\x1aG\xbd\xef\x95\x86\xa4\x97\x0e\x01|/\x16&\xd22\x1b\x13\xee\xb3rpa\xa7bf\x14-d\x89,\xd7\x9920\x95\xef\x91q\n\xdegG\xfb\x87o\x8e\x82A\xecC\x949\x83\x1a\x81r\xe8rv\xca\x7f \xdf\x04\xf5v\xcd\xf7\xba\x82\xdb\\c\xf9w\xd9\x85\x8f\xe2\x08\r\x88\x7fy/\x83+\xfa&\xe1.\x97\x97`\xb2\x82\xf3\xc7\xc3\x7f\xe7g\xcb\xa9\xff\xda\xf5\xe6\x9d\xfe\xaf\xd1^\x9d\xff,\xe3\x9a\x82\xc5\xff\x0e\x1b\xee\xc0\xd0\xfd`Q \x9dC\xc0\x1b12\x0e\xd1\x81qR\x03\x96\xbb2u<\xf0\xd62:_2h\xd8b\x15\x05\x1a\xebWMx\xda\x83\xbf\xf6B\xf7\xf5R\xa8\x85\xc3\xd5H\x84\x03\x9e\xca.\x04\n\xfa\x16@<\x8f&\x97\x9e\x83\x13H\xf1\x07\xbb\x0f\x92*\xec^Lb_\xbc)\x0c}\xfb\xe8\xb3\x10\xff\x93\xf5x\xcc9\x1e\x88\xffv\xad~\xe7\xfc\xa7\xb1\xd5j\xaf\xe2\x7f)\xf5\xdf\x19\xbf\x81\x05<\xaf\xa3\xddM\x87I\n=\xd4RV\xe8\x94\xd3I\xcd\xb4b\xa2\0?\x83\xc5X\"\x102\xbcG\x81\x8eh\xc0=*7\xc3\xf6?\xbeg\x93\xf6\r\xa5\xc8\xb1\x05+9 \x8e\xa8\xbb\x14\x95;\x8c3\xa3\x92\xdc\xe1\x01\x15V\x11\xa6BT&j\xc4\xa4{\xa3\x1d\x17\x91\xdeJ\xad\xd2\x01UGE\xd1\x87\na\xc8\x8c\x1cd\xa8\xbb0\x07\";6,7$\x01\x11\x1c\x1c\xfe\r\xa5\xcf\xb1e&\xcf2\xa511\x95G)h.L\xc6\xb5\x99*q\xb91\xc6\x8f\xebD\xf5\x16\0\x04\x0e\xd8\x08k[!\xfe-\xc8\xaac\xb2j\tl\x0eJ6=4\xa6VE*\tX\xa7'm\x87\x15\xe7\xe1\x13C\x95R\x90\xe6\xa9\xb2,\xc3\x04\xa9\x88!\xe1y\x1f\xd0T\xbcvo\xc90\xe3\xc1<\x1d\xb1(\xd7\xda\x9dsAm\xa0mFP\xc9\xe8\x0c\x9ek\x95\x03\x10i\x05PN\xa3\x02\xa7r\x9a\xcc\x18\x10O\xd6W\x99c\xeb*\xd1\xeb\x91\xd3\xdeJ\x80l\x8c\x95JT\xe6,\t\x9b\xbb\xe2u\xdc\xcc\xe3\x96\x96+\x11VT\x88\xc2\xbb\x98hKsL-u\x17iS\xd9\xebC\xca;\x88\x9b\xa7\x88'T\xae\xceL\xebs\xec6\xbdn\xc2{E1\x8c\xca\x99\xc6\xa1\xae7\xce,{\xec\xd9\xb3\x8f\\\xa70\xf0\xb3g\xde\x1e\x9e\xcfIP\x9eeI\xa9&\tKv 7\x81\xfc=\xe0\xb2\t\x18\xa9\x8ed\xc1\xf6O\x8f\x8b\x9f+\xd4\x1e\xa8!\xb9\x05\xb9\x17\xac\x9b\xe5\xd7\x98\xa5_\x96\xf9\x15\xf6)\xa7\xe2\x9b\xec#\x91\n>WX\xac\x86)\xf52\x93\x11#\x9e\xde\xb8\xec\x93\xa7\xeev\xdcl\x04\x10\xebg5$\xd7w\xe6\xc2\xa2G7\xc8'$\x9aQ\x031$\xdb\xe7F\xb8X \xafUy\xd1\x15t\xb5\xab\xce\xe39}h\xa5\xfejH\x1d\xc15\xd6\x1b\xf6\xe8\t\xd7\xd0\xcc.\x19\x89\xd1\xe7\x85\x17]\x0b\xf4]X\xe7\xb4Zl#\xc6l$l@\x89\xf3T\x93\xa3~\xca\xa5A\xe7c\x9c\x97ae\xe1h\x8b\x06Dg\x04A\x9c\r\x91\xd9\\,W\xe0;N'6A\0\xe8`\xd8\xe9\x08\n\xa4\x93NC\xa6]\xcd\xb1\x96yD9\x11\xdc\x91:7\xe6\xe2o\xd3-\x07\\\x01\x13W\x9c\xf5\xddR\xa7\x02\x82^+\xc40\x16\x83\xdc\x8d:'R\xab\x0c{b>#&\xe9\xb3\xce\xf6g\xe4\xce\xe6\x95#\xdd\xbaj\xbc\xc8V\xa9\xc4\x94\xed\x19\x86\xd0\xd7$\x0b\xd3\xe8<]\x9cc\xc7\xab:\xd5\xddT\xc7\xf3\x8a\xfd\x07\xb3\xcd(B`(#A\x13\x94\xf6k\x06/\x9f\xe3\xe9\"S\x82\x80\xa1\x1e\xb4\x9eO\xe3*sc\xaa\xc5o.\xae61\x16\xa8@&-\x8f\xd2\x8b\x17\x17\xce\xc8'\xc7s1i\x02\xfaR\x83\x0f\xf8\xef\xb0\x1bt\x0e\xa3D\x86\t9\xb1\r\xb1\x86\xba\x97\x03C\xe8e5\xea\xf3\xac\xda+\x0e\xe5\xab\x94\xf1,\xc2\xce!\x19\x05\x93kf\x1d\xcc\x96\x86\xd2\nu\x01Ut\x99\xd0\x03i\x8aV\x9b<\x01\xcb\\\xaaK\xdeiH1z\xf5\xb0`\xf1Mx\xdb\x08\x0b\x81J9\xae\xe6\xe4 V\x0eL\x801\x83\xeb\x98O\xf9\r\x87\xc3`\xf6\x97\x80\xbeL\x0f7g\xd7\xd9\xe5$\x92\x8f\xact\xe2FQX\x1cN$EH(\xb80f\x84G\x92\x92\xe5\xea\xcc\x16\x84\x15\xe7*\x9dr\xa1\xca\xc1\x9d\xc0\x91\xa2\xbd\xee\xca^\xeeZ\xfd\xc9*WX\x9e\xc5d%z\xd7\x99\x0f\x900@\n\xeb\xb0\xa9e]j\xcb\x1cP\x92\xdb\x98\xf2\x03\x89`\x1au\xa5K\x991p\xf59R//\xf0+B\x90\x1a\xd8\x8a\xc1\xa0E\x9d\xed\xf8E\xd0[\r\x80`\x03\x8e\x90\x1e\x16\xb9\xc5\xba\xa4\x1a!s\x94\xa2\xa5\"\x02\"q(\xb5\x8fI\x80\x0b\xf1$\xaaKM\x02\x94\xde\x05T\x95\xac\\3P\x16\xe0sS\x1f\x1f\x12x8\x85\xa7\x1a\xc2F\xef\0\xfe\xb3\x1c\x8b\xdcR\x1a-v\xa6E\x89\xd1\xe9\xd0ge\x89W\xda\x98\xec\r\xcf\x18\x07P\xb5:\xf6\xc5WX\xc7\xab\xd3\xb3w\xb4-\xb5\x87\xf7X\x08\"\xf6\xbc{\xa3\xadX\"\x1e\x17\xd2\x8e\x0b\x97i\xc6\xaf\xa0\xa9\x88e\xb7\xa0\xe9\x14R\xb9\x1e\xb7\xc36\x04\xd6\x06\xd07\xae=\xca\xccXa\xb0O/Q\xd7\xb4aE?v\xfeY\xfeiD8K\xbe\xb9\xe3tr\xbb<\xe3\xd4\xe9:\x8b\xc1hR7\xb8\xfe\xc2e\x1aj\x16\x8a\xa2\xe2\xf9\xd8\xb5\xff(\xcc\xfd%D\xb7a\x15r\t\x8d\x89\x950U\xe0}u\xc0\x01\xd6\xba\x8a\xb5\xc2\xe3\xd0G\xe7\xe1l@\xb9\xf2\xad\xb2\xa2L\x94\x13\xffQi2-<\xca\xa2\xc7ML\xaeM\xf9cn\xc3h\xb6l)G\x05\xab\r\x94\xa7\xbe\xff\xe3\x8a<\xcarH\x182}\xa4\x83\x80\x07\xbf\xffo\xde9\xffk7\x9a\xab\xf3\xbf\xa5\xec\xffL\x16\xfb\xd2\xc3\x7f\xe8R\x12\xc2\xa0\xb2\xbc\xf7W\x01\xf2\xb4\xe2\xdf\xe8(L\xe4u\xa0\xcd\xf2\xf6\x7fj\xed\xfa\xdd\xbf\xffil\xad\xbe\xffY\x8e\xfa\xae\x8c\x8a\xc5\xce\xce\xa1\xc0\x8dt\xc7r\xdf\xa3z\xbe(v<7f^o^zE\x81\xcbND\xd7\x96\x7f0\x98\xe0v\x87vb~\x17\x15\xef\xcbC\x84g\x04,%\xa5\xa6\xfbYR\x94\xba\xac\x9bR%\xb7Qp\xfd\x0b\xa8*\xe3q\xf4\xb0\xc9\xaa{\x05\xc1dv\xcbn\xeb\x80\xac\xe9\xa6\xec\xce\x0e\xfa\xed\x01\xba\x0b\xbd\xb3\xf3\x8a\x04\xdds\xdc6\x83<\x1dj\x9eml~?\xa5l|\x9d\xd2I\xba\xb7\xe1&\x9f\xa5u\xc4\xb7\xf5\x80x\xb2\xe7`\x11\xb8!\x90\x7f\x85&\xabku\xad\xaeo\xe9\xfa\x17K\x90\xd6\xdb\0@\0\0";
